(function(e,f){"function"===typeof define&&define.amd?define(["underscore","backbone"],function(m,k){return f(m||e._,k||e.Backbone)}):"object"===typeof exports?module.exports=f(require("underscore"),require("backbone")):f(_,Backbone)})(this,function(e,f){function m(a,d){function b(a){return String(a).replace(c,encodeURIComponent(c))}var c=f.Router.arrayValueSplit,h;if(!a)return"";h=function(a){return encodeURIComponent(a).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,
"%2A")};d=d||"";var l=[];e.each(a,function(a,g){g=d+g;if(e.isString(a)||e.isNumber(a)||e.isBoolean(a)||e.isDate(a))null!=a&&l.push(g+"="+b(h(a)));else if(e.isArray(a)){for(var f="",k=0;k<a.length;k++){var n=a[k];null!=n&&(f+=c+b(h(n)))}f&&l.push(g+"="+f)}else(f=m(a,g+"."))&&l.push(f)});return l.join("&")}function k(a){try{return decodeURIComponent(a.replace(/\+/g," "))}catch(d){return a}}function n(a,d){var b=a.split("&");e.each(b,function(a){a=a.split("=");d(a.shift(),a.join("="))})}var p=/^\?(.*)/,
s=/\((.*?)\)/g,q=/(\(\?)?:\w+/g,r=/\*\w+/g,t=/[\-{}\[\]+?.,\\\^$|#\s]/g,u=/^([^\?]*)/,v=/[\:\*]([^\:\?\/]+)/g,w=/^[#\/]|\s+$/g,x=/\/$/;f.Router.arrayValueSplit="|";e.extend(f.History.prototype,{getFragment:function(a,d){var b="";if(null==a)if(this._wantsPushState||!this._wantsHashChange||d){a=this.location.pathname;this.root&&this.root.length&&(b=this.root.replace(x,""));var c=this.location.search;a.indexOf(b)||(a=a.substr(b.length));c&&this._hasPushState&&(a+=c)}else a=this.getHash();return a.replace(w,
"")},getQueryParameters:function(a,d){a=this.getFragment(a,d);var b=a.replace(u,"");if(b=b.match(p)){var b=b[1],c={};n(b,function(a,b){b=k(b);c[a]?e.isString(c[a])?c[a]=[c[a],b]:c[a].push(b):c[a]=b});return c}return{}}});e.extend(f.Router.prototype,{initialize:function(a){this.encodedSplatParts=a&&a.encodedSplatParts},_routeToRegExp:function(a){var d=r.exec(a)||{index:-1},b=q.exec(a)||{index:-1},c=a.match(v)||[];a=a.replace(t,"\\$&").replace(s,"(?:$1)?").replace(q,function(a,b){return b?a:"([^\\/\\?]+)"}).replace(r,
"([^??]*?)");a=new RegExp("^"+(a+"(\\?.*)?")+"$");0<=d.index&&(a.splatMatch=0<=b?d.index-b.index:-1);a.paramNames=e.map(c,function(a){return a.replace(/\)$/,"").substring(1)});a.namedParameters=this.namedParameters;return a},_extractParameters:function(a,d){var b=a.exec(d).slice(1),c={};0<b.length&&!b[b.length-1]&&b.splice(b.length-1,1);var h=b.length&&b[b.length-1]&&b[b.length-1].match(p);if(h){var h=h[1],l={};if(h){var m=this;n(h,function(a,b){m._setParamValue(a,b,l)})}b[b.length-1]=l;e.extend(c,
l)}h=b.length;if(a.splatMatch&&this.encodedSplatParts){if(0>a.splatMatch)return b;h-=1}for(var g=0;g<h;g++)e.isString(b[g])&&(b[g]=k(b[g]),a.paramNames&&a.paramNames.length>=g-1&&(c[a.paramNames[g]]=b[g]));return f.Router.namedParameters||a.namedParameters?[c]:b},_setParamValue:function(a,d,b){a=a.replace("[]","");a=a.replace("%5B%5D","");a=a.split(".");for(var c=0;c<a.length;c++){var e=decodeURIComponent(a[c]);c===a.length-1?b[e]=this._decodeParamValue(d,b[e]):b=b[e]=b[e]||{}}},_decodeParamValue:function(a,
d){var b=f.Router.arrayValueSplit;if(b&&0<=a.indexOf(b)){for(var b=a.split(b),c=b.length-1;0<=c;c--)b[c]?b[c]=k(b[c]):b.splice(c,1);return b}a=k(a);return d?e.isArray(d)?(d.push(a),d):[d,a]:a},toFragment:function(a,d){d&&(e.isString(d)||(d=m(d)),d&&(a+="?"+d));return a}})});
