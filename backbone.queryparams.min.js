!function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(r,n){return t(r||e._,n||e.Backbone)}):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone")):t(_,Backbone)}(this,function(e,t){function r(n,a){function i(e){return String(e).replace(s,encodeURIComponent(s))}var o,s=t.Router.arrayValueSplit;if(!n)return"";o=function(e){return encodeURIComponent(e).replace(/'/,"%27").replace(/\(/,"%28").replace(/\)/,"%29").replace(/\*/,"%2A")},a=a||"";var c=[];return e.each(n,function(t,n){if(n=a+n,e.isString(t)||e.isNumber(t)||e.isBoolean(t)||e.isDate(t))null!=t&&c.push(n+"="+i(o(t)));else if(e.isArray(t)){for(var u="",l=0;l<t.length;l++){var p=t[l];null!=p&&(u+=s+i(o(p)))}u&&c.push(n+"="+u)}else{var h=r(t,n+".");h&&c.push(h)}}),c.join("&")}function n(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(t){return e}}function a(t,r){var n=t.split("&");e.each(n,function(e){var t=e.split("=");r(t.shift(),t.join("="))})}var i=/^\?(.*)/,o=/\((.*?)\)/g,s=/(\(\?)?:\w+/g,c=/\*\w+/g,u=/[\-{}\[\]+?.,\\\^$|#\s]/g,l=/^([^\?]*)/,p=/[\:\*]([^\:\?\/]+)/g,h=/^[#\/]|\s+$/g,f=/\/$/;t.Router.arrayValueSplit="|",e.extend(t.History.prototype,{getFragment:function(e,t){var r="";if(null==e)if(this._wantsPushState||!this._wantsHashChange||t){e=this.location.pathname,this.root&&this.root.length&&(r=this.root.replace(f,""));var n=this.location.search;e.indexOf(r)||(e=e.substr(r.length)),n&&this._hasPushState&&(e+=n)}else e=this.getHash();return e.replace(h,"")},getQueryParameters:function(t,r){t=this.getFragment(t,r);var o=t.replace(l,""),s=o.match(i);if(s){o=s[1];var c={};return a(o,function(t,r){r=n(r),c[t]?e.isString(c[t])?c[t]=[c[t],r]:c[t].push(r):c[t]=r}),c}return{}}}),e.extend(t.Router.prototype,{initialize:function(e){this.encodedSplatParts=e&&e.encodedSplatParts},_routeToRegExp:function(t){var r=c.exec(t)||{index:-1},n=s.exec(t)||{index:-1},a=t.match(p)||[];t=t.replace(u,"\\$&").replace(o,"(?:$1)?").replace(s,function(e,t){return t?e:"([^\\/\\?]+)"}).replace(c,"([^??]*?)"),t+="(\\?.*)?";var i=new RegExp("^"+t+"$");return r.index>=0&&(i.splatMatch=n>=0?r.index-n.index:-1),i.paramNames=e.map(a,function(e){return e.replace(/\)$/,"").substring(1)}),i.namedParameters=this.namedParameters,i},_extractParameters:function(r,o){var s=r.exec(o).slice(1),c={};s.length>0&&!s[s.length-1]&&s.splice(s.length-1,1);var u=s.length&&s[s.length-1]&&s[s.length-1].match(i);if(u){var l=u[1],p={};if(l){var h=this;a(l,function(e,t){h._setParamValue(e,t,p)})}s[s.length-1]=p,e.extend(c,p)}var f=s.length;if(r.splatMatch&&this.encodedSplatParts){if(r.splatMatch<0)return s;f-=1}for(var g=0;f>g;g++)e.isString(s[g])&&(s[g]=n(s[g]),r.paramNames&&r.paramNames.length>=g-1&&(c[r.paramNames[g]]=s[g]));return t.Router.namedParameters||r.namedParameters?[c]:s},_setParamValue:function(e,t,r){e=e.replace("[]",""),e=e.replace("%5B%5D","");for(var n=e.split("."),a=r,i=0;i<n.length;i++){var o=decodeURIComponent(n[i]);i===n.length-1?a[o]=this._decodeParamValue(t,a[o]):a=a[o]=a[o]||{}}},_decodeParamValue:function(r,a){var i=t.Router.arrayValueSplit;if(i&&r.indexOf(i)>=0){for(var o=r.split(i),s=o.length-1;s>=0;s--)o[s]?o[s]=n(o[s]):o.splice(s,1);return o}return r=n(r),a?e.isArray(a)?(a.push(r),a):[a,r]:r},toFragment:function(t,n){return n&&(e.isString(n)||(n=r(n)),n&&(t+="?"+n)),t}})});
